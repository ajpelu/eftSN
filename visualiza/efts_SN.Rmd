---
title: "Ecosystem functional types (EFTs) of Sierra Nevada"
output: 
  flexdashboard::flex_dashboard 
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library("flexdashboard")
library("tidyverse")
library("here")
library("raster")
library("rasterVis")
library("tmap")
library("mapview")
library("lubridate")
library("leaflet")
```


```{r}
# Read raster 
# evi_mean <- raster(here::here("data/EVI_medio_230m_2001-2016.tif"))

evi_mean <- raster(here::here("data/EVI_medio_230m_2001-2016_v2.tif"))
evi_mmax<- raster(here::here("data/EVI_MMAX_230m_2001-2016.tif"))
evi_cv <- raster(here::here("data/EVI_sCV_230m_2001-2016.tif"))
eft <- raster(here::here("/data/EFTs_230m_2001-2016.tif"))
rareza <- raster(here::here("data/Rareza_230m_2001-2016.tif"))
NAvalue(rareza) <- 0
eft_var <- raster(here::here("data/Variabilidad_interanual_230m_2001-2016.tif"))

disimilitud <- raster(here::here("data/Disimilud_EFTs_1840m_2001-2016.tif"))
NAvalue(disimilitud) <- 1

divesp <- raster(here::here("data/DivEspaMediaEFTs_1840m_2001-2016_.tif"))
NAvalue(divesp) <- 0

# Solve small variations of extent
evi_mmax <- projectRaster(evi_mmax, evi_mean)
evi_cv <- projectRaster(evi_cv, evi_mean)
eft <- projectRaster(eft, evi_mean)


# Units 
evi_mean <-evi_mean / 10000
evi_cv <- evi_cv / 100
eft <- round(eft)
evi_mmax <- round(evi_mmax)



# Add months to evi_mmax
evi_mmax_levels <- data.frame(level = 1:12, 
                              month = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
evi_mmax <- ratify(evi_mmax)
mmax_rat <-levels(evi_mmax)[[1]]
mmax_rat <- mmax_rat %>% left_join(evi_mmax_levels, by = c("ID"="level"))
levels(evi_mmax) <- mmax_rat 



# eft attributes 
# https://rdrr.io/cran/raster/man/factor.html
eft_palette <- read_csv(here::here("data/paleta_eft.csv"))

# Asign eft attributes 
# see an example from https://annakrystalli.me/intro-r-gis/raster.html 
eft_levels <- eft_palette %>% dplyr::select(eft_id, eft_code, eft_color) %>% as.data.frame()

eft <- ratify(eft) 
eft_rat <- levels(eft)[[1]]
eft_rat <- eft_rat %>% left_join(eft_levels, by=c("ID" = "eft_id"))
levels(eft) <- eft_rat


eftFactor <- deratify(eft, "eft_code")


# Rename layers 
names(evi_mean) <- "EVI_Mean"
names(evi_mmax) <- "EVI_DateMax"
names(evi_cv) <- "EVI_sCV"
names(eft) <- "EFT"
names(eftFactor) <- "EFT"
names(rareza) <- "EFT rarity"
names(eft_var) <- "EFT var"


# Create stack 
evi_stack <- stack(eft, evi_mean, evi_mmax, evi_cv, RAT = TRUE)

pixel <- rasterToPolygons(evi_stack)
pixel <- merge(pixel, eft_palette[,c("eft_code", "eft_id")], by.x = "EFT", by.y = "eft_id")
pixel@data <- pixel@data[,-1]
names(pixel)[4] <- "EFT"
pixel <- pixel[,c(4,1:3)]
pixel$EVI_DateMaxMonth<- as.character(month(ymd(010101) + months(pixel$EVI_DateMax-1), label=TRUE, abbr = TRUE))
pixel@data <- pixel@data[,-3]
names(pixel)[4] <- "EVI_monthMax"



# Remove 0 from etfvar 
eft_var[eft_var < 1] <- NA


```


EFTs
=====================================  

```{r}
tmap_mode("view")

mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
  tm_shape(eftFactor, name = "EFT") + 
  tm_raster(palette = eft_palette$eft_color,
            alpha = 0.5, legend.is.portrait = FALSE) + 
  tmap_options(max.categories = 64) +
  tm_shape(pixel) + tm_polygons(labels = NULL, 
                                popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
                                               "Seasonality (EVI scV)" = "EVI_sCV", 
                                               "Phenology (Month max EVI)" = "EVI_monthMax"), 
                                alpha=.01, border.col = NA, border.alpha = 0.001, 
                                group = "EVI values") +
  tm_shape(rareza, name ="EFT rarity") +
  tm_raster(legend.is.portrait = FALSE, colorNA = NULL, 
            palette = "Blues", n = 10, 
            group = "EFT rarity") +
  tm_shape(eft_var, name = "EFT interannual variability") + 
  tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL,  
            group = "EFT interannual variability", 
            palette = "BuPu", n =16) + 
  tm_shape(disimilitud, name = "Dissimilarity") + 
  tm_raster(legend.is.portrait = FALSE, colorNA = NULL, 
            palette = "Reds", n = 10, contrast = c(0, 1), 
            group = "Dissimilarity") +
  tm_shape(divesp, name = "DivEsp") + 
  tm_raster(legend.is.portrait = FALSE, colorNA = NULL, style = "pretty",
            palette = "Purples", n = 12, 
            group = "DivEsp") 
  

mapita <- mapita %>% 
  tmap_leaflet() %>% 
  leaflet::hideGroup("EFT rarity") %>% 
  leaflet::hideGroup("EFT interannual variability") %>% 
  leaflet::hideGroup("DivEsp") %>% 
  leaflet::hideGroup("Dissimilarity") 

mapita 

```



Info
=====================================

Column {.tabset}
-----------------------------------------------------------------------

Aqui podemos poner lo que queramos sobre como se calculan  los EFTs y demás 

**Bibliografía**

* Cazorla, B., Meijide, A., Cabello, J., Peñas, J., Alcaraz-Segura, D. Ecosystem Functional Types as descriptors of ecosystem functional diversity at regional scale (en preparación). 2019a 

* añadir mas biblio 

### EFTs

Esto es un ejemplo 
***TENEMOS QUE DECIDIR QUE PONEMOS*** 


EFTs were identified following Alcaraz-Segura et al., (2013), from the three EFAs obtained. The range of values of each EFA was divided into four intervals, giving a potential number of 64 EFTs (4 × 4 × 4). For EVI_DMAX, the four intervals agreed with the four seasons of the year. For EVI_mean and EVI_sCV, we extracted the first, second, and third quartiles for each year and then calculated the quartiles means for the 14-year period. To name EFTs, we used two letters and a number: the first capital letter indicates net primary production (EVI_mean), increasing from A to D; the second small letter represents seasonality (EVI_sCV), decreasing from a to d; the numbers are a phenological indicator of the growing season (EVI_DMAX), with values 1-spring, 2-summer, 3-autumn, 4-winter. To summarize the EFTs of the 2001–2016 period, we calculated the dominant EFT (i.e., the mode value for each pixel) of the period.


Mas información: 




### Characterizing Ecosystem Functional Diversity 

***TENEMOS QUE DECIDIR QUE PONEMOS*** 


Credits
=====================================

Aquí irían los créditos (si queremos ponerlos)
 Y el enlace a los datos etc etc.  
