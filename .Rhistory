evi_mmax_levels <- data.frame(level = 1:12,
month = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
evi_mmax <- ratify(evi_mmax)
mmax_rat <-levels(evi_mmax)[[1]]
mmax_rat <- mmax_rat %>% left_join(evi_mmax_levels, by = c("ID"="level"))
levels(evi_mmax) <- mmax_rat
# eft attributes
# https://rdrr.io/cran/raster/man/factor.html
eft_palette <- read_csv(here::here("data/paleta_eft.csv"))
# Asign eft attributes
# see an example from https://annakrystalli.me/intro-r-gis/raster.html
eft_levels <- eft_palette %>% dplyr::select(eft_id, eft_code, eft_color) %>% as.data.frame()
eft <- ratify(eft)
eft_rat <- levels(eft)[[1]]
eft_rat <- eft_rat %>% left_join(eft_levels, by=c("ID" = "eft_id"))
levels(eft) <- eft_rat
eftFactor <- deratify(eft, "eft_code")
# Rename layers
names(evi_mean) <- "EVI_Mean"
names(evi_mmax) <- "EVI_DateMax"
names(evi_cv) <- "EVI_sCV"
names(eft) <- "EFT"
names(eftFactor) <- "EFT"
# Create stack
evi_stack <- stack(eft, evi_mean, evi_mmax, evi_cv, RAT = TRUE)
pixel <- rasterToPolygons(evi_stack)
pixel <- merge(pixel, eft_palette[,c("eft_code", "eft_id")], by.x = "EFT", by.y = "eft_id")
pixel@data <- pixel@data[,-1]
names(pixel)[4] <- "EFT"
pixel <- pixel[,c(4,1:3)]
pixel$EVI_DateMaxMonth<- as.character(month(ymd(010101) + months(pixel$EVI_DateMax-1), label=TRUE, abbr = TRUE))
pixel@data <- pixel@data[,-3]
names(pixel)[4] <- "EVI_monthMax"
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5,) +
tm_add_legend(is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001) +
tm_layout(legend.stack = "horizontal")
mapita
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5,) +
tm_add_legend(is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001)
mapita
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5,) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001)
mapita
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001)
mapita
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001) +
tm_layout(legend.stack = "horizontal")
mapita
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
legend.is.portrait = TRUE) +
tm_layout(legend.stack = "horizontal")
mapita
eft_var <- raster(here::here("data/Variabilidad_interanual_230m_2001-2016.tif"))
rareza <- raster(here::here("data/Rareza_230m_2001-2016.tif"))
plot(rareza)
plot(eft_var)
rareza
names(rareza) <- "EFT rarity"
names(rareza) <- "EFT rarity"
names(eft_var) <- "EFT var"
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001) +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE)
mapita
plot(rareza)
head(rareza)
rareza2 <- rareza[rareza == 0] <- NA
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001) +
tm_shape(rareza2, name ="EFT rarity") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE)
mapita
hist(rareza)
approxNA(rareza)
?tm_raster
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001) +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL)
mapita
palette_explore()
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001) +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn")
mapita
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001) +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn") +
mapita %>% tmap_leaflet() %>%
leaflet::hideGroup("pixel")
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn") +
mapita <- mapita %>% tmap_leaflet() %>%
leaflet::hideGroup("EVI values")
mapita
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn") +
# mapita <- mapita %>% tmap_leaflet() %>%
#   leaflet::hideGroup("EVI values")
mapita
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn")
# mapita <- mapita %>% tmap_leaflet() %>%
#   leaflet::hideGroup("EVI values")
mapita
mapita <- mapita %>% tmap_leaflet() %>% leaflet::hideGroup("EVI values")
mapita
tmaptools::palette_explorer()
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL,
palette = "Blues", n = 10, contrast = c(0, 1),
group = "EFT rarity") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn",
group = "EFT interannual variability",
palette = "BuPu", n = 14)
mapita <- mapita %>% tmap_leaflet() %>% leaflet::hideGroup("EFT interannual variability", "EFT rarity")
mapita
hist(eft_var)
#
eft_var[eft_var < 1] <- NA
hist(eft_var)
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL,
palette = "Blues", n = 10, contrast = c(0, 1),
group = "EFT_rarity") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL, palette = "BuGn",
group = "EFT_var",
palette = "BuPu", n = 14)
mapita <- mapita %>% tmap_leaflet() %>% leaflet::hideGroup("EFT_var", "EFT_rarity")
mapita
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL,
palette = "Blues", n = 10, contrast = c(0, 1),
group = "EFT_rarity") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL,
group = "EFT_var",
palette = "BuPu", n = 14)
mapita <- mapita %>% tmap_leaflet() %>% leaflet::hideGroup("EFT_var", "EFT_rarity")
mapita
hist(EFT.var)
hist(eft_var)
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL,
palette = "Blues", n = 10, contrast = c(0, 1),
group = "EFT_rarity") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL,
group = "EFT_var",
palette = "BuPu", n =16)
mapita <- mapita %>% tmap_leaflet() %>% leaflet::hideGroup("EFT_var", "EFT_rarity")
mapita
mapita <- mapita %>%
tmap_leaflet() %>%
leaflet::hideGroup("EFT_var") %>%
leaflet::hideGroup("EFT_rarity")
mapita
disimilitud <- raster(here::here("data/Disimilitud_EFTs_1840m_2001-2016.tif"))
disimilitud <- raster(here::here("data/Disimilud_EFTs_1840m_2001-2016.tif"))
plot(disimilitud)
hist(disimilitud)
rareza
plot(rareza)
plot(rareza2)
disimilitud <- raster(here::here("data/Disimilud_EFTs_1840m_2001-2016.tif"))
disimilitud <- disimilitud[disimilitud == 1] <- NA
plot(disimilitud)
disimilitud <- disimilitud[disimilitud = 1] <- NA
plot(disimilitud)
disimilitud <- disimilitud[disimilitud >= 1] <- NA
plot(disimilitud)
disimilitud <- raster(here::here("data/Disimilud_EFTs_1840m_2001-2016.tif"))
NAvalue(disimilitud) <- 1
plot(disimilitud)
divesp <- raster(here::here("data/DivEspaMediaEFTs_1840m_2001-2016_.tif"))
plot(divesp)
NAvalue(divesp) <- 0
plot(divesp)
tmaptools::palette_explorer()
?tm_raster
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL,
palette = "Blues", n = 10, contrast = c(0, 1),
group = "EFT rarity") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL,
group = "EFT interannual variability",
palette = "BuPu", n =16) +
tm_shape(disimilitud, name = "Dissimilarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL,
palette = "Reds", n = 10, contrast = c(0, 1),
group = "Dissimilarity") +
tm_shape(divesp, name = "DivEsp") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL, style = "pretty",
palette = "Purples", n = 12,
group = "DivEsp")
mapita <- mapita %>%
tmap_leaflet() %>%
leaflet::hideGroup("EFT rarity") %>%
leaflet::hideGroup("EFT interannual variability") %>%
leaflet::hideGroup("DivEsp") %>%
leaflet::hideGroup("Dissimilarity")
mapita
plot(rarituy)
plot(rarity)
plot(rareza)
rareza
rareza <- raster(here::here("data/Rareza_230m_2001-2016.tif"))
plot(rareza)
hist(rareza)
NAvalue(rareza) <- 0
# Read raster
# evi_mean <- raster(here::here("data/EVI_medio_230m_2001-2016.tif"))
evi_mean <- raster(here::here("data/EVI_medio_230m_2001-2016_v2.tif"))
evi_mmax<- raster(here::here("data/EVI_MMAX_230m_2001-2016.tif"))
evi_cv <- raster(here::here("data/EVI_sCV_230m_2001-2016.tif"))
eft <- raster(here::here("/data/EFTs_230m_2001-2016.tif"))
rareza <- raster(here::here("data/Rareza_230m_2001-2016.tif"))
NAvalue(rareza) <- 0
eft_var <- raster(here::here("data/Variabilidad_interanual_230m_2001-2016.tif"))
disimilitud <- raster(here::here("data/Disimilud_EFTs_1840m_2001-2016.tif"))
NAvalue(disimilitud) <- 1
divesp <- raster(here::here("data/DivEspaMediaEFTs_1840m_2001-2016_.tif"))
NAvalue(divesp) <- 0
# Solve small variations of extent
evi_mmax <- projectRaster(evi_mmax, evi_mean)
evi_cv <- projectRaster(evi_cv, evi_mean)
eft <- projectRaster(eft, evi_mean)
# Units
evi_mean <-evi_mean / 10000
evi_cv <- evi_cv / 100
eft <- round(eft)
evi_mmax <- round(evi_mmax)
# Add months to evi_mmax
evi_mmax_levels <- data.frame(level = 1:12,
month = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
evi_mmax <- ratify(evi_mmax)
mmax_rat <-levels(evi_mmax)[[1]]
mmax_rat <- mmax_rat %>% left_join(evi_mmax_levels, by = c("ID"="level"))
levels(evi_mmax) <- mmax_rat
# eft attributes
# https://rdrr.io/cran/raster/man/factor.html
eft_palette <- read_csv(here::here("data/paleta_eft.csv"))
# Asign eft attributes
# see an example from https://annakrystalli.me/intro-r-gis/raster.html
eft_levels <- eft_palette %>% dplyr::select(eft_id, eft_code, eft_color) %>% as.data.frame()
eft <- ratify(eft)
eft_rat <- levels(eft)[[1]]
eft_rat <- eft_rat %>% left_join(eft_levels, by=c("ID" = "eft_id"))
levels(eft) <- eft_rat
eftFactor <- deratify(eft, "eft_code")
# Rename layers
names(evi_mean) <- "EVI_Mean"
names(evi_mmax) <- "EVI_DateMax"
names(evi_cv) <- "EVI_sCV"
names(eft) <- "EFT"
names(eftFactor) <- "EFT"
names(rareza) <- "EFT rarity"
names(eft_var) <- "EFT var"
# Create stack
evi_stack <- stack(eft, evi_mean, evi_mmax, evi_cv, RAT = TRUE)
pixel <- rasterToPolygons(evi_stack)
pixel <- merge(pixel, eft_palette[,c("eft_code", "eft_id")], by.x = "EFT", by.y = "eft_id")
pixel@data <- pixel@data[,-1]
names(pixel)[4] <- "EFT"
pixel <- pixel[,c(4,1:3)]
pixel$EVI_DateMaxMonth<- as.character(month(ymd(010101) + months(pixel$EVI_DateMax-1), label=TRUE, abbr = TRUE))
pixel@data <- pixel@data[,-3]
names(pixel)[4] <- "EVI_monthMax"
# Remove 0 from etfvar
eft_var[eft_var < 1] <- NA
tmap_mode("view")
mapita <- tm_basemap(c("Esri.WorldGrayCanvas", "Esri.WorldTopoMap")) +
tm_shape(eftFactor, name = "EFT") +
tm_raster(palette = eft_palette$eft_color,
alpha = 0.5, legend.is.portrait = FALSE) +
tmap_options(max.categories = 64) +
tm_shape(pixel) + tm_polygons(labels = NULL,
popup.vars = c("Productivity (EVI mean)" = "EVI_Mean",
"Seasonality (EVI scV)" = "EVI_sCV",
"Phenology (Month max EVI)" = "EVI_monthMax"),
alpha=.01, border.col = NA, border.alpha = 0.001,
group = "EVI values") +
tm_shape(rareza, name ="EFT rarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL,
palette = "Blues", n = 10,
group = "EFT rarity") +
tm_shape(eft_var, name = "EFT interannual variability") +
tm_raster(alpha = 0.5, legend.is.portrait = FALSE, colorNA = NULL,
group = "EFT interannual variability",
palette = "BuPu", n =16) +
tm_shape(disimilitud, name = "Dissimilarity") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL,
palette = "Reds", n = 10, contrast = c(0, 1),
group = "Dissimilarity") +
tm_shape(divesp, name = "DivEsp") +
tm_raster(legend.is.portrait = FALSE, colorNA = NULL, style = "pretty",
palette = "Purples", n = 12,
group = "DivEsp")
mapita <- mapita %>%
tmap_leaflet() %>%
leaflet::hideGroup("EFT rarity") %>%
leaflet::hideGroup("EFT interannual variability") %>%
leaflet::hideGroup("DivEsp") %>%
leaflet::hideGroup("Dissimilarity")
mapita
